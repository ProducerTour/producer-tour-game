// This is your Prisma schema file
// Learn more: https://pris.ly/d/prisma-schema

generator client {
  provider      = "prisma-client-js"
  output        = "../src/generated/client"
  engineType    = "binary"
  binaryTargets = ["native", "debian-openssl-3.0.x"]
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// Enums
enum UserRole {
  ADMIN
  WRITER
  LEGAL
  MANAGER
  PUBLISHER
  STAFF
  VIEWER
}

enum ProType {
  BMI
  ASCAP
  SESAC
  GMR
  MLC
  OTHER
}

enum StatementStatus {
  UPLOADED
  PROCESSING
  PROCESSED
  PUBLISHED
  ERROR
}

enum PaymentStatus {
  UNPAID
  PENDING
  PAID
}

enum PayoutStatus {
  PENDING
  APPROVED
  PROCESSING
  COMPLETED
  FAILED
  CANCELLED
}

enum ApplicationStatus {
  PENDING
  APPROVED
  REJECTED
  CONTACTED
}

enum ApplicationTier {
  PRIORITY_A
  PRIORITY_B
  PRIORITY_C
  PRIORITY_D
}

enum OpportunityStatus {
  OPEN
  ON_HOLD
  CLOSED
}

enum OpportunityPriority {
  HIGH
  MEDIUM
  LOW
}

enum PlacementStatus {
  PENDING            // User submitted, awaiting admin review
  DOCUMENTS_REQUESTED // Admin needs more info from writer
  APPROVED           // Admin approved, sent to placement tracker
  DENIED             // Admin rejected submission
  TRACKING           // Actively being tracked (formerly ACTIVE)
  COMPLETED          // Case closed
}

enum StreamingPlatform {
  SPOTIFY
  APPLE_MUSIC
  AMAZON_MUSIC
  YOUTUBE_MUSIC
  TIDAL
  DEEZER
  SOUNDCLOUD
  OTHER
}

enum DocumentCategory {
  PRE_PROCESSED_STATEMENT
  PROCESSED_STATEMENT
  CONTRACT
  AGREEMENT
  INVOICE
  TAX_DOCUMENT
  SPLIT_SHEET
  PRODUCER_AGREEMENT
  OTHER
}

enum DocumentVisibility {
  ADMIN_ONLY
  USER_SPECIFIC
  ALL_WRITERS
}

// Models
model User {
  id        String   @id @default(cuid())
  email     String   @unique
  password  String
  role      UserRole @default(WRITER)
  firstName String?
  middleName String?
  lastName  String?
  writerIpiNumber String?  // Writer IPI/CAE number for songwriter registration
  publisherName String?  // Publisher name for songwriter registration
  publisherIpiNumber String?  // Publisher IPI/CAE number for publishing registration
  subPublisherName String?  // Sub Publisher Name / Administrator (not related to admin role)
  subPublisherIpiNumber String?  // Sub Publisher IPI number
  // Optional per-writer commission override (percentage 0.00-100.00). If null, use global CommissionSettings
  commissionOverrideRate Decimal? @db.Decimal(5, 2)
  // Upload access for VIEWER role (allows statement uploads)
  canUploadStatements Boolean @default(false)

  // Stripe Connect fields for payment processing
  stripeAccountId         String? @unique // Stripe Connect Express account ID
  stripeOnboardingComplete Boolean @default(false) // Whether onboarding is complete
  stripeAccountStatus     String? // Stripe account status (pending, complete, restricted, etc.)
  stripeDetailsSubmitted  Boolean @default(false) // Whether user submitted details to Stripe

  // Password reset fields
  resetToken        String?   @unique // Cryptographically secure token for password reset
  resetTokenExpiry  DateTime? // Expiration time for reset token (1 hour recommended)

  // Wallet balance fields for writer payouts
  availableBalance  Decimal @default(0) @db.Decimal(12, 6) // Balance available for withdrawal
  pendingBalance    Decimal @default(0) @db.Decimal(12, 6) // Balance in pending withdrawal requests
  lifetimeEarnings  Decimal @default(0) @db.Decimal(12, 6) // Total all-time earnings

  // Notification preferences
  emailNotificationsEnabled      Boolean @default(true)  // Master email toggle
  statementNotificationsEnabled  Boolean @default(true)  // Statement/payment emails
  monthlySummaryEnabled          Boolean @default(false) // Monthly earning summaries

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  producer              Producer?
  statementItems        StatementItem[]
  publishedStatements   Statement[]       @relation("PublishedBy")
  processedPayments     Statement[]       @relation("PaymentProcessedBy")
  applications          Application[]
  placements            Placement[]
  credits               Credit[]
  proSubmissions        ProSubmission[]
  advanceScenarios      AdvanceScenario[]
  uploadedDocuments     Document[]        @relation("UploadedBy")
  userDocuments         Document[]        @relation("UserDocuments")
  payoutRequests        PayoutRequest[]

  @@map("users")
}

model Producer {
  id             String   @id @default(cuid())
  userId         String   @unique
  producerName   String
  writerIpiNumber      String?
  publisherIpiNumber   String?
  proAffiliation ProType?
  status         String   @default("active")
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  // Relations
  user           User            @relation(fields: [userId], references: [id], onDelete: Cascade)
  statementItems StatementItem[]

  @@index([writerIpiNumber])
  @@index([publisherIpiNumber])
  @@index([proAffiliation])
  @@map("producers")
}

model Statement {
  id                String          @id @default(cuid())
  proType           ProType
  filename          String
  filePath          String?
  status            StatementStatus @default(UPLOADED)
  uploadDate        DateTime        @default(now())
  publishedAt       DateTime?
  publishedById     String?
  totalRevenue      Decimal         @default(0) @db.Decimal(12, 6) // Gross revenue (before commission)
  totalPerformances Int             @default(0)

  // Commission totals
  totalCommission   Decimal         @default(0) @db.Decimal(12, 6) // Total commission amount
  totalNet          Decimal         @default(0) @db.Decimal(12, 6) // Total net (after commission)

  // Payment processing
  paymentStatus        PaymentStatus @default(UNPAID)
  paymentProcessedAt   DateTime?
  paymentProcessedById String?
  stripeTransferGroup  String? // Stripe transfer group ID for tracking related transfers
  stripeTransferIds    Json? // Array of Stripe transfer IDs for writer payouts

  statementPeriod   String?
  periodStart       DateTime?
  periodEnd         DateTime?
  metadata          Json?
  createdAt         DateTime        @default(now())
  updatedAt         DateTime        @updatedAt

  // Relations
  publishedBy        User?           @relation("PublishedBy", fields: [publishedById], references: [id])
  paymentProcessedBy User?           @relation("PaymentProcessedBy", fields: [paymentProcessedById], references: [id])
  items              StatementItem[]
  documents          Document[]

  @@index([proType])
  @@index([status])
  @@index([paymentStatus])
  @@index([uploadDate])
  @@map("statements")
}

model StatementItem {
  id              String   @id @default(cuid())
  statementId     String
  workTitle       String
  userId          String
  producerId      String?   // Optional - not all writers have producers
  revenue         Decimal  @db.Decimal(12, 6) // Gross revenue (before commission) - increased precision for accuracy
  performances    Int      @default(0)
  splitPercentage Decimal? @default(100.00) @db.Decimal(5, 2) // Writer's percentage share (0.00-100.00)
  writerIpiNumber String?  // IPI number at time of assignment

  // Commission tracking
  commissionRate     Decimal  @default(0.00) @db.Decimal(5, 2) // Commission percentage (0.00-100.00)
  commissionAmount   Decimal  @default(0.00) @db.Decimal(12, 6) // Calculated commission in dollars - increased precision
  commissionRecipient String? // Who receives commission (e.g., "Producer Tour", "Admin Fee")
  netRevenue         Decimal  @default(0.00) @db.Decimal(12, 6) // Revenue after commission - increased precision

  // Payment visibility
  isVisibleToWriter Boolean  @default(false) // Controls whether writer can see this item
  paidAt           DateTime? // When payment was processed and item became visible

  periodStart     DateTime?
  periodEnd       DateTime?
  metadata        Json?
  createdAt       DateTime @default(now())

  // Relations
  statement Statement @relation(fields: [statementId], references: [id], onDelete: Cascade)
  user      User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  producer  Producer? @relation(fields: [producerId], references: [id], onDelete: Cascade)

  @@index([statementId])
  @@index([userId])
  @@index([producerId])
  @@index([workTitle])
  @@index([isVisibleToWriter])
  @@map("statement_items")
}

model Application {
  id               String            @id @default(cuid())
  userId           String?
  name             String
  email            String
  phone            String?
  social           String?
  primaryLink      String
  otherLinks       String?
  pro              String?
  distributor      String?
  catalogSize      String
  placements       String
  royalties        String
  readiness        Json? // Array of readiness items
  engagement       String
  needs            Json? // Array of selected needs
  notes            String?
  score            Int               @default(0)
  tier             ApplicationTier?
  status           ApplicationStatus @default(PENDING)
  internalNotes    String?
  submittedAt      DateTime          @default(now())
  updatedAt        DateTime          @updatedAt

  // Relations
  user User? @relation(fields: [userId], references: [id], onDelete: SetNull)

  @@index([email])
  @@index([status])
  @@index([tier])
  @@index([score])
  @@map("applications")
}

model Opportunity {
  id           String              @id @default(cuid())
  title        String
  brief        String              @db.Text
  genres       Json? // Array of genres
  budget       String?
  deadline     DateTime?
  contact      String?
  link         String?
  status       OpportunityStatus   @default(OPEN)
  priority     OpportunityPriority @default(MEDIUM)
  notes        String?             @db.Text
  tags         Json? // Array of tags
  displayOrder Int                 @default(0)
  createdAt    DateTime            @default(now())
  updatedAt    DateTime            @updatedAt

  @@index([status])
  @@index([priority])
  @@index([deadline])
  @@map("opportunities")
}

model Consultation {
  id            String   @id @default(cuid())
  companyName   String
  contactName   String
  email         String
  phone         String?
  title         String?
  website       String?
  businessType  String?
  companySize   String?
  budget        String?
  services      Json? // Array of services
  projectScope  String?  @db.Text
  timeline      String?
  volumeNeeds   String?
  additionalInfo String? @db.Text
  hearAbout     String?
  status        String   @default("new")
  internalNotes String?  @db.Text
  submittedAt   DateTime @default(now())
  updatedAt     DateTime @updatedAt

  @@index([email])
  @@index([status])
  @@map("consultations")
}

model Placement {
  id              String            @id @default(cuid())
  userId          String
  title           String
  artist          String
  platform        StreamingPlatform @default(OTHER)
  releaseDate     DateTime
  isrc            String?
  spotifyTrackId  String?
  streams         Int               @default(0)
  estimatedStreams Boolean          @default(false) // Flag for estimated vs real
  status          PlacementStatus   @default(PENDING)
  lastSyncedAt    DateTime?
  metadata        Json? // Store additional track info (album, image, etc.)
  notes           String?           @db.Text

  // AudioDB enrichment fields
  albumName       String?           // Album title from AudioDB
  genre           String?           // Music genre (Hip-Hop, Pop, R&B, etc.)
  releaseYear     String?           // Release year
  label           String?           // Record label
  albumArtUrl     String?           // Album artwork thumbnail
  albumArtHQUrl   String?           // High-quality album artwork
  artistThumbUrl  String?           // Artist thumbnail image
  artistBio       String?           @db.Text // Artist biography
  musicbrainzId   String?           // MusicBrainz ID for external linking
  audioDbArtistId String?           // AudioDB artist ID
  audioDbAlbumId  String?           // AudioDB album ID
  audioDbData     Json?             // Complete AudioDB response for reference

  // Work Registration workflow fields
  submittedAt     DateTime?         // When writer submitted for review
  reviewedAt      DateTime?         // When admin reviewed
  reviewedBy      String?           // Admin user ID who reviewed
  denialReason    String?           @db.Text // Reason if denied
  documentsRequested String?        @db.Text // What documents admin needs

  // Case/tracking info (for approved items)
  caseNumber      String?           @unique // Auto-generated: PT-YYYY-###
  dealTerms       String?           @db.Text // Deal terms and agreements
  advanceAmount   Decimal?          @db.Decimal(12, 2) // Advance payment if any
  royaltyPercentage Decimal?        @db.Decimal(5, 2) // Royalty split percentage

  createdAt       DateTime          @default(now())
  updatedAt       DateTime          @updatedAt

  // Relations
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
  credits PlacementCredit[]
  documents Document[]

  @@index([userId])
  @@index([isrc])
  @@index([spotifyTrackId])
  @@index([platform])
  @@index([status])
  @@index([genre])
  @@index([audioDbArtistId])
  @@index([caseNumber])
  @@index([submittedAt])
  @@map("placements")
}

model PlacementCredit {
  id              String   @id @default(cuid())
  placementId     String   // FK to Placement
  firstName       String   // Collaborator first name
  lastName        String   // Collaborator last name
  role            String   // Producer, Writer, Composer, etc.
  splitPercentage Decimal  @db.Decimal(5, 2) // 0.00 to 100.00
  pro             String?  // Performing Rights Organization (BMI, ASCAP, SESAC)
  ipiNumber       String?  // IPI/CAE number if available
  isPrimary       Boolean  @default(false) // Is this the submitting user
  notes           String?  @db.Text
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  // Relations
  placement Placement @relation(fields: [placementId], references: [id], onDelete: Cascade)

  @@index([placementId])
  @@index([firstName, lastName])
  @@map("placement_credits")
}

model PlacementDeal {
  id              String               @id @default(cuid())

  // Core Placement Info
  clientFullName  String               // Legal name
  clientPKA       String               // p/k/a "Producer Name"
  songTitle       String
  artistName      String
  streams         String?              // Text field for formatted numbers like "1,000,000"
  label           String?
  coProducers     String?              // Comma-separated or text

  // Status & Action
  status          String?              // e.g., "Pending Agreement", "Redline"
  action          String?              // Action item

  // Legal Fee Section
  legalFeeAmount  String?              // e.g., "$500" or "10%"
  legalFeeType    String               @default("Flat Fee") // "Flat Fee" or "Percentage"
  legalFeePaymentSource String         @default("Out of Advance") // "Out of Advance" or "Paid Directly"
  hasLegalFeeBeenPaid String           @default("No") // "No" or "Yes"

  // Deal Terms
  advance         String?              // Dollar amount as text
  masterRoyalty   String?              // e.g., "2% PPD"
  pubPercent      String?              // e.g., "50%"
  sxLOD           String?              // e.g., "20%"

  // Contracting Info
  contractContactName      String?
  contractCompany          String?
  contractContactEmail     String?
  contractMailingAddress   String?
  contractSoundExchangePayee String?
  contractCreditLine       String?

  // Other
  contractLink    String?              // URL
  released        Boolean              @default(false)

  // Checklist
  advReceived     String               @default("Not Received") // "Not Received" or "Received"
  masterCol       String               @default("Not Collecting") // "Not Collecting", "Collecting", "Advance hasn't recouped"
  soundEx         String               @default("Not Collecting") // "Submitted LOD", "Not Collecting", "Collecting"
  publicPerf      String               @default("Not Collecting") // "Not Collecting", "Collecting"
  mech            String               @default("Not Collecting") // "Not Collecting", "Collecting"
  agreement       String               @default("Draft has not been received") // Various states

  // Notes
  notes           String?              @db.Text

  // Billing AI Fields
  billingClientName        String?
  billingClientPKA         String?
  billingClientAddress     String?
  billingClientCity        String?
  billingProjectTitle      String?
  billingInvoiceNumber     String?     @unique
  billingArtistLegal       String?
  billingArtistStage       String?
  billingLabelName         String?
  billingBillToEmail       String?
  billingBillToContact     String?
  billingIssueDate         String?     // Stored as text for flexibility
  billingDueDate           String?
  billingAmount            String?     // Dollar amount as text
  billingCostsExpenses     String?
  billingSalesTax          String?
  billingAmountPaid        String?
  billingServices          String?     @db.Text
  billingPaymentTerms      String?     @db.Text
  billingPaymentChannel    String?
  billingBookkeepingNotes  String?     @db.Text

  // Banking Details
  billingBankAccountName   String?
  billingBankName          String?
  billingBankAddress       String?
  billingRoutingNumber     String?
  billingAccountNumber     String?
  billingSwiftCode         String?

  // Invoice Draft Storage
  invoiceDraftHtml         String?     @db.Text

  // Tracking
  createdById     String?              // Admin who created
  lastModifiedBy  String?              // Admin who last modified

  createdAt       DateTime             @default(now())
  updatedAt       DateTime             @updatedAt

  @@index([clientFullName])
  @@index([songTitle])
  @@index([status])
  @@index([billingInvoiceNumber])
  @@map("placement_deals")
}

model Credit {
  id              String   @id @default(cuid())
  userId          String
  songTitle       String
  role            String   // Producer, Composer, Writer, etc.
  ipiNumber       String?
  splitPercentage Decimal  @db.Decimal(5, 2) // 0.00 to 100.00
  metadata        Json? // Additional credit information
  notes           String?  @db.Text
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  // Relations
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([songTitle])
  @@index([ipiNumber])
  @@map("credits")
}

model ProSubmission {
  id           String   @id @default(cuid())
  userId       String
  proName      ProType // ASCAP, BMI, SESAC
  submittedAt  DateTime
  placementIds Json? // Array of placement IDs submitted
  metadata     Json? // Additional submission details
  notes        String?  @db.Text
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  // Relations
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([proName])
  @@index([submittedAt])
  @@map("pro_submissions")
}

model AdvanceScenario {
  id                    String   @id @default(cuid())
  userId                String
  scenarioName          String   // User's name for this scenario

  // Input parameters
  catalogSize           Int      // Number of songs in catalog
  monthlyRoyalties      Decimal  @db.Decimal(12, 2) // Average monthly royalties
  contractLength        Int      // In months
  artistIncome          Int      // Percentage (0-100) - income paid to artist during term
  includeNewReleases    Boolean  @default(false) // Include future releases
  switchDistributors    Boolean  @default(false) // Willing to switch distributors

  // Calculated outputs (stored for historical reference)
  upfrontAdvance        Decimal  @db.Decimal(12, 2)
  newReleaseAdvance     Decimal? @db.Decimal(12, 2) // Only if includeNewReleases = true
  optionAdvance         Decimal? @db.Decimal(12, 2)
  recoupmentRate        Int      // Percentage (0-100)
  estimatedTotal        Decimal  @db.Decimal(12, 2)

  notes                 String?  @db.Text
  createdAt             DateTime @default(now())
  updatedAt             DateTime @updatedAt

  // Relations
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([createdAt])
  @@map("advance_scenarios")
}

model Document {
  id          String              @id @default(cuid())
  filename    String
  originalName String
  fileSize    Int                 // Size in bytes
  filePath    String              // S3 or local storage path
  mimeType    String
  category    DocumentCategory
  description String?             @db.Text
  visibility  DocumentVisibility  @default(ADMIN_ONLY)

  // Relations
  uploadedById String
  uploadedBy   User               @relation("UploadedBy", fields: [uploadedById], references: [id], onDelete: Cascade)

  relatedUserId String?           // For user-specific documents
  relatedUser   User?             @relation("UserDocuments", fields: [relatedUserId], references: [id], onDelete: Cascade)

  statementId  String?            // For linking to statements (pre-processed, etc.)
  statement    Statement?         @relation(fields: [statementId], references: [id], onDelete: SetNull)

  placementId  String?            // For linking to placements (split sheets, agreements)
  placement    Placement?         @relation(fields: [placementId], references: [id], onDelete: SetNull)

  metadata    Json?               // Additional document metadata
  tags        Json?               // Array of tags for organization

  createdAt   DateTime            @default(now())
  updatedAt   DateTime            @updatedAt

  @@index([uploadedById])
  @@index([relatedUserId])
  @@index([statementId])
  @@index([placementId])
  @@index([category])
  @@index([visibility])
  @@map("documents")
}

model CommissionSettings {
  id                String   @id @default(cuid())
  commissionRate    Decimal  @db.Decimal(5, 2) // Commission percentage (0.00-100.00)
  recipientName     String   // e.g., "Producer Tour", "Admin Fee"
  description       String?  @db.Text // Optional description of rate change
  effectiveDate     DateTime @default(now()) // When this rate became/becomes active
  isActive          Boolean  @default(true) // Only one should be active at a time

  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt

  @@index([isActive])
  @@index([effectiveDate])
  @@map("commission_settings")
}

model ProducerTourPublisher {
  id                String   @id @default(cuid())
  ipiNumber         String   @unique // Helper: Producer Tour IPI that collects for writers without own publisher
  publisherName     String   // e.g., "Producer Tour Publishing", "Producer Tour LLC (ASCAP)"
  notes             String?  @db.Text // Optional notes about this publisher entity
  isActive          Boolean  @default(true) // Can be deactivated without deleting

  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt

  @@index([ipiNumber])
  @@index([isActive])
  @@map("producer_tour_publishers")
}

model PayoutRequest {
  id                String        @id @default(cuid())
  userId            String
  amount            Decimal       @db.Decimal(12, 6) // Amount requested for withdrawal
  status            PayoutStatus  @default(PENDING)
  requestedAt       DateTime      @default(now())
  approvedAt        DateTime?     // When admin approved
  processedAt       DateTime?     // When Stripe transfer completed
  completedAt       DateTime?     // When marked as completed
  stripeTransferId  String?       // Stripe transfer ID if applicable
  stripePayoutId    String?       // Stripe payout ID if applicable
  failureReason     String?       @db.Text // Reason if failed
  adminNotes        String?       @db.Text // Admin notes about this request
  statementIds      Json?         // Array of statement IDs included in this payout

  // Relations
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([userId])
  @@index([status])
  @@index([requestedAt])
  @@map("payout_requests")
}

model SystemSettings {
  id                      String   @id @default(cuid())
  minimumWithdrawalAmount Decimal  @default(50) @db.Decimal(12, 2) // Minimum withdrawal amount in dollars

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("system_settings")
}
