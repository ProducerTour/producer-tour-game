// This is your Prisma schema file
// Learn more: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// Enums
enum UserRole {
  ADMIN
  WRITER
  LEGAL
}

enum ProType {
  BMI
  ASCAP
  SESAC
  OTHER
}

enum StatementStatus {
  UPLOADED
  PROCESSING
  PROCESSED
  PUBLISHED
  ERROR
}

enum ApplicationStatus {
  PENDING
  APPROVED
  REJECTED
  CONTACTED
}

enum ApplicationTier {
  PRIORITY_A
  PRIORITY_B
  PRIORITY_C
  PRIORITY_D
}

enum OpportunityStatus {
  OPEN
  ON_HOLD
  CLOSED
}

enum OpportunityPriority {
  HIGH
  MEDIUM
  LOW
}

enum PlacementStatus {
  ACTIVE
  PENDING
  COMPLETED
}

enum StreamingPlatform {
  SPOTIFY
  APPLE_MUSIC
  AMAZON_MUSIC
  YOUTUBE_MUSIC
  TIDAL
  DEEZER
  SOUNDCLOUD
  OTHER
}

// Models
model User {
  id        String   @id @default(cuid())
  email     String   @unique
  password  String
  role      UserRole @default(WRITER)
  firstName String?
  lastName  String?
  ipiNumber String?  // IPI/CAE number for PRO registration
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  producer         Producer?
  statementItems   StatementItem[]
  publishedStatements Statement[] @relation("PublishedBy")
  applications     Application[]
  placements       Placement[]
  credits          Credit[]
  proSubmissions   ProSubmission[]
  advanceScenarios AdvanceScenario[]

  @@map("users")
}

model Producer {
  id             String   @id @default(cuid())
  userId         String   @unique
  producerName   String
  ipiNumber      String?
  proAffiliation ProType?
  status         String   @default("active")
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  // Relations
  user           User            @relation(fields: [userId], references: [id], onDelete: Cascade)
  statementItems StatementItem[]

  @@index([ipiNumber])
  @@index([proAffiliation])
  @@map("producers")
}

model Statement {
  id                String          @id @default(cuid())
  proType           ProType
  filename          String
  filePath          String?
  status            StatementStatus @default(UPLOADED)
  uploadDate        DateTime        @default(now())
  publishedAt       DateTime?
  publishedById     String?
  totalRevenue      Decimal         @default(0) @db.Decimal(12, 2)
  totalPerformances Int             @default(0)
  statementPeriod   String?
  periodStart       DateTime?
  periodEnd         DateTime?
  metadata          Json?
  createdAt         DateTime        @default(now())
  updatedAt         DateTime        @updatedAt

  // Relations
  publishedBy User?           @relation("PublishedBy", fields: [publishedById], references: [id])
  items       StatementItem[]

  @@index([proType])
  @@index([status])
  @@index([uploadDate])
  @@map("statements")
}

model StatementItem {
  id              String   @id @default(cuid())
  statementId     String
  workTitle       String
  userId          String
  producerId      String?   // Optional - not all writers have producers
  revenue         Decimal  @db.Decimal(12, 2)
  performances    Int      @default(0)
  splitPercentage Decimal? @default(100.00) @db.Decimal(5, 2) // Writer's percentage share (0.00-100.00)
  writerIpiNumber String?  // IPI number at time of assignment
  periodStart     DateTime?
  periodEnd       DateTime?
  metadata        Json?
  createdAt       DateTime @default(now())

  // Relations
  statement Statement @relation(fields: [statementId], references: [id], onDelete: Cascade)
  user      User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  producer  Producer? @relation(fields: [producerId], references: [id], onDelete: Cascade)

  @@index([statementId])
  @@index([userId])
  @@index([producerId])
  @@index([workTitle])
  @@map("statement_items")
}

model Application {
  id               String            @id @default(cuid())
  userId           String?
  name             String
  email            String
  phone            String?
  social           String?
  primaryLink      String
  otherLinks       String?
  pro              String?
  distributor      String?
  catalogSize      String
  placements       String
  royalties        String
  readiness        Json? // Array of readiness items
  engagement       String
  needs            Json? // Array of selected needs
  notes            String?
  score            Int               @default(0)
  tier             ApplicationTier?
  status           ApplicationStatus @default(PENDING)
  internalNotes    String?
  submittedAt      DateTime          @default(now())
  updatedAt        DateTime          @updatedAt

  // Relations
  user User? @relation(fields: [userId], references: [id], onDelete: SetNull)

  @@index([email])
  @@index([status])
  @@index([tier])
  @@index([score])
  @@map("applications")
}

model Opportunity {
  id           String              @id @default(cuid())
  title        String
  brief        String              @db.Text
  genres       Json? // Array of genres
  budget       String?
  deadline     DateTime?
  contact      String?
  link         String?
  status       OpportunityStatus   @default(OPEN)
  priority     OpportunityPriority @default(MEDIUM)
  notes        String?             @db.Text
  tags         Json? // Array of tags
  displayOrder Int                 @default(0)
  createdAt    DateTime            @default(now())
  updatedAt    DateTime            @updatedAt

  @@index([status])
  @@index([priority])
  @@index([deadline])
  @@map("opportunities")
}

model Consultation {
  id            String   @id @default(cuid())
  companyName   String
  contactName   String
  email         String
  phone         String?
  title         String?
  website       String?
  businessType  String?
  companySize   String?
  budget        String?
  services      Json? // Array of services
  projectScope  String?  @db.Text
  timeline      String?
  volumeNeeds   String?
  additionalInfo String? @db.Text
  hearAbout     String?
  status        String   @default("new")
  internalNotes String?  @db.Text
  submittedAt   DateTime @default(now())
  updatedAt     DateTime @updatedAt

  @@index([email])
  @@index([status])
  @@map("consultations")
}

model Placement {
  id              String            @id @default(cuid())
  userId          String
  title           String
  artist          String
  platform        StreamingPlatform @default(OTHER)
  releaseDate     DateTime
  isrc            String?
  spotifyTrackId  String?
  streams         Int               @default(0)
  estimatedStreams Boolean          @default(false) // Flag for estimated vs real
  status          PlacementStatus   @default(PENDING)
  lastSyncedAt    DateTime?
  metadata        Json? // Store additional track info (album, image, etc.)
  notes           String?           @db.Text
  createdAt       DateTime          @default(now())
  updatedAt       DateTime          @updatedAt

  // Relations
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([isrc])
  @@index([spotifyTrackId])
  @@index([platform])
  @@index([status])
  @@map("placements")
}

model Credit {
  id              String   @id @default(cuid())
  userId          String
  songTitle       String
  role            String   // Producer, Composer, Writer, etc.
  ipiNumber       String?
  splitPercentage Decimal  @db.Decimal(5, 2) // 0.00 to 100.00
  metadata        Json? // Additional credit information
  notes           String?  @db.Text
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  // Relations
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([songTitle])
  @@index([ipiNumber])
  @@map("credits")
}

model ProSubmission {
  id           String   @id @default(cuid())
  userId       String
  proName      ProType // ASCAP, BMI, SESAC
  submittedAt  DateTime
  placementIds Json? // Array of placement IDs submitted
  metadata     Json? // Additional submission details
  notes        String?  @db.Text
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  // Relations
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([proName])
  @@index([submittedAt])
  @@map("pro_submissions")
}

model AdvanceScenario {
  id                    String   @id @default(cuid())
  userId                String
  scenarioName          String   // User's name for this scenario

  // Input parameters
  catalogSize           Int      // Number of songs in catalog
  monthlyRoyalties      Decimal  @db.Decimal(12, 2) // Average monthly royalties
  contractLength        Int      // In months
  artistIncome          Int      // Percentage (0-100) - income paid to artist during term
  includeNewReleases    Boolean  @default(false) // Include future releases
  switchDistributors    Boolean  @default(false) // Willing to switch distributors

  // Calculated outputs (stored for historical reference)
  upfrontAdvance        Decimal  @db.Decimal(12, 2)
  newReleaseAdvance     Decimal? @db.Decimal(12, 2) // Only if includeNewReleases = true
  optionAdvance         Decimal? @db.Decimal(12, 2)
  recoupmentRate        Int      // Percentage (0-100)
  estimatedTotal        Decimal  @db.Decimal(12, 2)

  notes                 String?  @db.Text
  createdAt             DateTime @default(now())
  updatedAt             DateTime @updatedAt

  // Relations
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([createdAt])
  @@map("advance_scenarios")
}
